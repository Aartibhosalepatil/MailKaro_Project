{% extends 'base.html' %}
{% load static %}
{% block content %}
<style>
    /* Your existing styles... */
    .email-card {
        margin-top: 30px;
        background: #fff;
        border-radius: 6px;
        box-shadow: 0 0 10px #ddd;
        padding: 2em;
        font-family: sans-serif;
    }
    .email-header {
        border-bottom: 1px solid #ccc;
        padding-bottom: 1em;
        margin-bottom: 1.5em;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }
    .email-header h2 {
        margin: 0 0 0.5em 0;
        color: var(--mailkaro-blue);
    }
    .email-body {
        margin-bottom: 2em;
    }
    .email-body pre,
    .email-body div {
        padding: 1em;
        background: #f9f9f9;
        border-radius: 4px;
        overflow-x: auto;
    }
    .email-attachments h4 {
        margin-bottom: 0.5em;
    }
    .email-attachments ul {
        list-style: none;
        padding-left: 0;
    }
    .email-attachments li {
        margin-bottom: 0.3em;
    }
    .email-attachments a {
        color: #1976d2;
        text-decoration: none;
    }
    .email-attachments a:hover {
        text-decoration: underline;
    }
    .back-link {
        margin-top: 1.5em;
        display: inline-block;
        color: var(--mailkaro-blue);
        text-decoration: none;
    }
    .back-link:hover {
        text-decoration: underline;
    }
    /* Scroll-to-top button styles */
    .scroll-to-top {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background-color: var(--mailkaro-blue);
        color: white;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: background-color 0.3s, opacity 0.3s;
        opacity: 0;
        visibility: hidden;
        z-index: 1000;
        text-decoration: none;
    }
    .scroll-to-top.show {
        opacity: 1;
        visibility: visible;
    }
    .scroll-to-top:hover {
        background-color: var(--mailkaro-blue-dark);
    }

    /* --- NEW STYLES for the Gmail-like dropdown card --- */
    .email-header-left {
        flex-grow: 1; /* Pushes the date to the right */
        display: flex;
        flex-direction: column;
    }
    .email-meta-container {
        position: relative;
        display: inline-block;
    }
    .email-meta-toggle {
        font-weight: 500;
        color: #212121;
        cursor: pointer;
        position: relative;
    }
    .email-meta-card {
        display: none;
        position: absolute;
        top: calc(100% + 5px);
        left: 0;
        min-width: 300px;
        background-color: #fff;
        border: 1px solid #ddd;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 15px;
        z-index: 100;
    }
    .email-meta-card.show {
        display: block;
    }
    .email-meta-card p {
        margin: 0.3em 0;
    }
    .email-meta-card p strong {
        font-weight: 700;
        color: #555;
    }
    .email-meta-card p span {
        font-weight: normal;
        color: #333;
    }
    .header-date {
        margin-left: 20px; /* Add some spacing */
        color: #555;
        font-size: 0.9em;
        margin-top: 40px;
    }
</style>

<a class="back-link" href="{% url 'inbox' %}">‚Üê Back to Inbox</a>
<div class="email-card">
    <div class="email-header">
        <div class="email-header-left">
            <h2>{{ email.subject }}</h2>
            <div class="email-meta-container">
                <span class="email-meta-toggle" id="email-meta-toggle" title="show details">{{ email.from_email }}</span>
                <div class="email-meta-card" id="email-meta-card">
                    <p><strong>From: </strong> <span>{{ email.from_email }}</span></p>
                    <p><strong>To: </strong> <span>{{ email.to }}</span></p>
                    {% if email.cc %}<p><strong>CC: </strong> <span>{{ email.cc }}</span></p>{% endif %}
                    {% if email.bcc %}<p><strong>BCC: </strong> <span>{{ email.bcc }}</span></p>{% endif %}
                    <p><strong>Date: </strong> <span>{{ email.timestamp }}</span></p>
                    <p><strong>Subject: </strong>{{email.subject}}</p>
                </div>
            </div>
        </div>
        <div class="header-date">
            {{ email.timestamp|date:"M d, Y, h:i A" }}
           ({{email.timestamp| timesince}})
        </div>
    </div>
    <div class="email-body">
        {% if email.body_html %}
            <div>{{ email.body_html|safe }}</div>
        {% else %}
            <pre>{{ email.body_plain }}</pre>
        {% endif %}
    </div>

    {% if email.attachments.exists and email.attachments.count > 0 %}
        <div class="email-attachments">
            <h4>Attachments:</h4>
            <ul>
                {% for att in email.attachments.all %}
                    <li>
                        {% if att.id %}
                            <a href="{% url 'download_attachment' att.id %}">{{ att.filename }}</a>
                        {% else %}
                            {{ att.filename }}
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}
</div>

<a href="#" id="scrollToTopBtn" class="scroll-to-top" title="Go to top">
    <i class="fas fa-arrow-up"></i>
</a>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const scrollToTopBtn = document.getElementById('scrollToTopBtn');
        const emailMetaToggle = document.getElementById('email-meta-toggle');
        const emailMetaCard = document.getElementById('email-meta-card');

        window.addEventListener('scroll', function() {
            if (window.scrollY > 200) {
                scrollToTopBtn.classList.add('show');
            } else {
                scrollToTopBtn.classList.remove('show');
            }
        });

        scrollToTopBtn.addEventListener('click', function(e) {
            e.preventDefault();
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        // Toggle the email meta card
        emailMetaToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            emailMetaCard.classList.toggle('show');
        });

        // Hide the card when clicking outside of it
        document.addEventListener('click', function(e) {
            if (!emailMetaCard.contains(e.target) && !emailMetaToggle.contains(e.target)) {
                emailMetaCard.classList.remove('show');
            }
        });
    });
</script>
{% endblock %}